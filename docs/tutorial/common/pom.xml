<?xml version="1.0" encoding="UTF-8"?>
<!-- 
  The common parent pom that will be used by the EJB3 tutorials.

-->
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"  
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">

	<properties>
		<!--  Comma delimited files which need to be deployed. The order in which the files will be deployed
		will be the same as they appear in this property value. Each tutorial can override this value. The default
		deployable is the jar file that the tutorial generates. -->
		<jboss.ejb3.tutorial.deployables>${pom.build.directory}/${pom.artifactId}.${pom.packaging}</jboss.ejb3.tutorial.deployables>
	  	<!--  Versions -->
	    <version.maven-jboss-as-control-plugin>0.1.1-SNAPSHOT</version.maven-jboss-as-control-plugin>
	    <version.org.jboss.jbossas_jboss-as-client>5.0.0.GA</version.org.jboss.jbossas_jboss-as-client>
  	</properties>

  <!-- Parent - The jboss-ejb3-tutorial-parent (Aggregator) will act as a parent
   
   -->

  <parent>
    <groupId>org.jboss.ejb3</groupId>
    <artifactId>jboss-ejb3-tutorial-parent</artifactId>
    <version>0.1.0-SNAPSHOT</version>
    <relativePath>../</relativePath>
  </parent>

	

  <modelVersion>4.0.0</modelVersion>
  <groupId>org.jboss.ejb3</groupId>
  <artifactId>jboss-ejb3-tutorial-common</artifactId>
  <version>0.1.0-SNAPSHOT</version>
  <packaging>pom</packaging>
  <name>JBoss EJB3 Tutorial Common Parent POM</name>
  <url>http://labs.jboss.com/jbossejb3/</url>
  <description>
    Common Parent POM for JBoss EJB3 Tutorials
  </description>


	<build>
  		<!--  The project is current not in the Maven standard structure. So
  		let's tell Maven where the source resides for each module -->
   		<sourceDirectory>./src</sourceDirectory>
   
   		<plugins>
   			<!--  
   				Maven (2.0.9) has a limitation which does not allow the same plugin to appear twice
   				for the same phase. As a result we cannot deploy (using JBossAS Maven plugin), 
   				run the client(using the ant-run plugin) and undeploy (using JBossAS Maven plugin) as part
   				of the same "install" phase. More details here 
   				http://www.nabble.com/Plugin-execution-order-incorrect-in-Maven-2.0.9-when-multiple-plugins-are-associated-with-the-same-phase-td21113516.html#a21113516
   				
   				
   				And since we do not have a "pre-install" (where we could have deployed to JBossAS) and "post-install"
   				(where we could have undeployed), let's rely on the following phases to deploy, run the client and
   				finally undeploy:
   				
   				1) The tutorial will be deployed using the JBossAS plugin during the "pre-integration-test" phase (which is before the
   				"integration-test" phase)
   				2) The client will be run using the ant plugin during the "integration-test" phase
   				3) The tutorial will be undeployed during the "post-integration-test" phase
   				
   				
   				
   			  -->
   			  
			<!--  JBossAS Maven plugin for startup/shutdown/deploy/undeploy
			and other AS control -->
		  	<plugin>
          		<groupId>org.jboss.maven.plugins.jbossas</groupId>
            	<artifactId>maven-jboss-as-control-plugin</artifactId>
            	<version>${version.maven-jboss-as-control-plugin}</version>
            	
            	<!-- Executions -->
            	<!-- 
                	Deploy the tutorial 
              	-->
            	
                <executions>
              		 <execution>
              		   	<id>deploy-tutorial</id>
                		<goals>
                  			<goal>deploy</goal>
                		</goals>
                		<phase>pre-integration-test</phase>
                		<configuration>	
                  			<serverConfigName>${jboss.server.config}</serverConfigName>
                  			<files>
                    			${jboss.ejb3.tutorial.deployables}
                  			</files>
                  			<jboss.test.run>true</jboss.test.run>
                		</configuration>
              		</execution>
				    
			

				</executions>

			</plugin>

		    <!--  Ant plugin to run Ant tasks -->      
			<plugin>
        		<artifactId>maven-antrun-plugin</artifactId>
        		<!--  Run the tutorial (client) -->		
        		<executions>
        			<execution>
	          			<id>run-tutorial</id>
					    <phase>integration-test</phase>
	            		<configuration>
		              		<!--  Individual child tutorials, will provide the ${ejb3.tutorial.client} property value  -->
		              		<tasks>
		              			<!--  The classpath for the tutorial client -->
		              			<path id="ejb3.tutorial.classpath">
			      					<!-- Only the jbossall-client.jar should ideally be sufficient -->
				      				<fileset dir="${jboss.home}/client">
				         				<include name="**/jbossall-client.jar"/>
				      				</fileset>
				      				<pathelement location="${build.outputDirectory}"/>
		   						</path>
		   						<echo message="*********************************** JBoss EJB3 Tutorials ***********************************" />
		   						<echo message="**** Running ${ejb3.tutorial.client}" />
		   						<java classname="${ejb3.tutorial.client}" fork="yes" dir="." failonerror="true">
		         					<classpath refid="ejb3.tutorial.classpath"/>
		         					<classpath refid="maven.runtime.classpath"/>
		      					</java>
		      					<echo message="********************************************************************************************" />
		              		</tasks>
	            		</configuration>
	            		<goals>
	              			<goal>run</goal>
	            		</goals>
          			</execution>
		        </executions>
      		</plugin>
      		
      		<!--  Undeploy the tutorial after the client is run -->
      		<plugin>
          		<groupId>org.jboss.maven.plugins.jbossas</groupId>
            	<artifactId>maven-jboss-as-control-plugin</artifactId>
            	<version>${version.maven-jboss-as-control-plugin}</version>
            	
            	
                <executions>
              		   	<execution>
        		        <id>undeploy-tutorial</id>
        		        <goals>
                  			<goal>undeploy</goal>
                		</goals>
                		<phase>post-integration-test</phase>
                		<configuration>	
                  			<serverConfigName>${jboss.server.config}</serverConfigName>
                  			<files>
                    			${jboss.ejb3.tutorial.deployables}
                  			</files>
                  			<jboss.test.run>true</jboss.test.run>
                		</configuration>
              		</execution>
				    
			

				</executions>

			</plugin>
      		
		</plugins>
  
  		<!--  Include the jndi.properties and the log4j.xml in the classpath -->
   		<resources>
   			<!-- Include files from the root of the tutorial into the
   			root of output artifact jar -->
   			<resource>
   				<!--  Relative to each child tutorial -->
   				<directory>./</directory>
   				<includes>
   					<include>*.properties</include>
   					<include>log4j.xml</include>
   				</includes>
   			</resource>
   			<!--  Include xml files from the META-INF of the tutorial into the
   			META-INF folder of output artifact jar
   			 -->
   			<resource>
   				
   				<directory>./META-INF</directory>
   				<includes>
   					<include>*.xml</include>
   				</includes>
   				<targetPath>META-INF</targetPath>
   			</resource>
   			
   		</resources>
  	</build>  


	<!-- Dependencies -->
	<dependencies>
  		
      
      <dependency>
            <groupId>org.jboss.jbossas</groupId>
            <artifactId>jboss-as-client</artifactId>
            <version>${version.org.jboss.jbossas_jboss-as-client}</version>
            <type>pom</type>
        </dependency>
      
  	
	</dependencies>
  
</project>
