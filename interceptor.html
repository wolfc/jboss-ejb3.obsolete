<html>
<body>
<p>
<h2>EJB Interceptors</h2>

The EJB 3.0 spec defines the ability to apply custom made interceptors to the business methods of your session beans, and
to your message driven beans. EJB 3.0 interceptors take the form of methods annotated with the <tt>@javax.ejb.AroundInvoke</tt>
annotation. These methods must have the following signature:
</p><p>
<pre>
   @javax.ejb.AroundInvoke
   public Object &lt;Arbitrary method name&gt;(javax.ejb.InvocationContext ctx) throws java.lang.Exception
</pre>
</p><p>
You can either define an interceptor method in the bean class itself, or in separate classes.
</p><p>
<h4>Interceptor method in bean class</h4>

</p><p>
Take a look at <a href="src/org/jboss/tutorial/interceptor/bean/EmailMDB.java">EmailMDB.java</a>. It contains this method:
<pre>
   @AroundInvoke
   public Object mdbInterceptor(InvocationContext ctx) throws Exception
   {
      System.out.println("*** Intercepting call to EmailMDB.mdbInterceptor()");
      return ctx.proceed();
   }
</pre>
</p><p>
This method will wrap the call to EmailMDB.onMessage(). The call to ctx.proceed() causes the next object in the chain of
interceptors to get invoked. At the end of the chain of interceptors, the actual bean method gets called.
</p><p>
<h4>Interceptors defined in additional classes</h4>

Take a look at <a href="src/org/jboss/tutorial/interceptor/bean/EmailSystemBean.java">EmailSystemBean.java</a>. The class has been
annotated:
</p><p>
<pre>
   @Stateless
   @Interceptors ({@Interceptor("org.jboss.tutorial.interceptor.bean.TracingInterceptor"), @Interceptor("org.jboss.tutorial.interceptor.bean.OtherInterceptor")})
   public class EmailSystemBean
   {
      ...
   }
</pre>
</p><p>
This means that TracingInterceptor and OtherInterceptor wrap all calls to this bean's business methods.
If you look at <a href="src/org/jboss/tutorial/interceptor/bean/TracingInterceptor.java">TracingInterceptor.java</a> and
<a href="src/org/jboss/tutorial/interceptor/bean/OtherInterceptor.java">OtherInterceptor.java</a>, you will see that they
both contain an @AroundInvoke method each. They wrap the calls to the business methods of EmailSystemBean. In addition,
EmailSystemBean contains an interceptor method defined on the bean class itself;
</p><p>
<pre>
   @AroundInvoke
   public Object myBeanInterceptor(InvocationContext ctx) throws Exception
   {
      if (ctx.getMethod().getName().equals("emailLostPassword"))
      {
         System.out.println("*** EmailSystemBean.myBeanInterceptor - username: " + ctx.getParameters()[0]);
      }

      return ctx.proceed();
   }
</pre>
</p><p>
</p><p>
If a bean contains only one external interceptor class, you can use the <tt>@javax.ejb.Interceptor</tt> annotation instead of
<tt>@javax.ejb.Interceptors</tt>:
<pre>
   @Stateless
   @Interceptor("MyInterceptor")
   public class MyBean
   {
      ...
   }
</pre>
</p><p>
<h4>Ordering of interceptors</h4>

In the case of several interceptors for a bean, they are invoked in the following order:
<ol>
<li>If present, the interceptors from the @Interceptors annotation on the bean class are invoked in the order they were specified. (If the @Interceptor annotation was used instead, that one interceptor is used.)</li>

<li>The @AroundInvoke method of the bean class is invoked.</li>
</ol>

</p><p>
So for the example provided, when invoking business methods on the EmailSystem bean, this is the ordering of interceptors:
<pre>
   TracingInterceptor.log()
      wraps calls to
   OtherInterceptor.intercept()
      wraps calls to
   EmailSystemBean.myBeanInterceptor()
      wraps calls to
   EmailSystemBean business methods
</pre>
and when EmailMDB receives a message
<pre>
   EmailMDB.mdbInterceptor()
      wraps calls to
   EmailMDB.onMessage()
</pre>
</p><p>
<h4>InvocationContext</h4>

As you have seen the @AroundInvoke annotated interceptor methods all take a parameter of type <tt>javax.ejb.InvocationContext</tt>.
The definition of InvocationContext is:
<pre>
   package javax.ejb;

   public interface InvocationContext {
      public Object getBean();
      public java.lang.reflect.Method getMethod();
      public Object[] getParameters();
      public void setParameters(Object[] params);
      public EJBContext getEJBContext();
      public java.util.Map getContextData();
      public Object proceed() throws Exception;
   }
</pre>
</p><p>
<ul>
<li><tt>getBean()</tt> - returns the bean instance on which we are calling a method</li>
<li><tt>getMethod()</tt> - returns the method we are calling on the bean instance</li>
<li><tt>getParameters()</tt> - returns the parameters for the method call</li>
<li><tt>setParameters()</tt> - allows you to modify the parameters for the method call</li>
<li><tt>getEJBContext()</tt> - gives the interceptor methods access to the bean's EJBContext. (The AroundInvoke methods share the JNDI name space of the bean for whose methods they are invoked and execute within the same transaction and security context as the business methods for which they are invoked.)</li>
<li><tt>getContextData</tt> - The EJB interceptions are stateless, but the same InvocationContext instance is used for each interceptor method in a chain. If you want to pass values between interceptor methods in the business method invocation you can store them in the Map retured by getContextData().</li>
<li><tt>proceed</tt> - As discussed, invokes the next interceptor, or if we are in the last interceptor invokes the target bean method.</li>
</ul>
</p><p>
<h4>Building and Running</h4>

To build and run the example, make sure you have <tt>ejb3.deployer</tt> installed in JBoss 4.0.x and have JBoss running.  See the reference manual on how to install EJB 3.0.
<pre>
Unix:    $ export JBOSS_HOME=&lt;where your jboss 4.0 distribution is&gt;
Windows: $ set JBOSS_HOME=&lt;where your jboss 4.0 distribution is&gt;
$ ant
$ ant run

</pre>
</p><p>
Look at the JBoss console window to see the output of the interceptions taking place
</p><p>
<pre>
15:51:27,847 INFO  [STDOUT] *** TracingInterceptor intercepting
15:51:27,847 INFO  [STDOUT] *** OtherInterceptor intercepting
15:51:27,847 INFO  [STDOUT] *** EmailSystemBean.myBeanInterceptor - username: whatever
15:51:27,847 INFO  [STDOUT] ----------------
15:51:27,847 INFO  [STDOUT] In EmailSystemBean business method
15:51:27,847 INFO  [STDOUT] ----------------
15:51:27,857 INFO  [STDOUT] Message sent successfully to remote queue.
15:51:27,857 INFO  [STDOUT] *** TracingInterceptor invocation of org.jboss.tutorial.interceptor.bean.EmailSystemBean.emailLostPassword() took 10ms
15:51:27,867 INFO  [STDOUT] *** EmailMDB.mdbInterceptor intercepting
15:51:27,867 INFO  [STDOUT] ----------------
15:51:27,867 INFO  [STDOUT] Got message, sending email
15:51:27,867 INFO  [STDOUT] ----------------
</pre>
</p><p>
</p><p>
</p>
</body>
</html>
